name: Deploy Web Example App
on:
  workflow_run:
    workflows:
      - Push CI/CD
      - PR CI/CD
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
    deploy-push:
      name: "Deploy Web Example App (Push)"
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: ./example
      if: >
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.event != 'pull_request' &&
        github.event.workflow_run.conclusion == 'success'
      steps:
        - name: Download Web Artifact
          uses: actions/github-script@v6.4.1
          with:
            script: |
              var artifacts = await github.actions.listWorkflowRunArtifacts({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 run_id: ${{github.event.workflow_run.id }},
              });
              var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                return artifact.name == "web-build"
              })[0];
              var download = await github.actions.downloadArtifact({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 artifact_id: matchArtifact.id,
                 archive_format: 'zip',
              });
              var fs = require('fs');
              fs.writeFileSync('${{github.workspace}}/web-build.zip', Buffer.from(download.data));
        - name: Unzip Web Artifact
          run: unzip web-build.zip
        - name: Publish Live Web App
          uses: FirebaseExtended/action-hosting-deploy@main
          with:
            repoToken: "${{ secrets.GITHUB_TOKEN }}"
            firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FLEAFLET }}"
            channelId: live
            projectId: fleaflet-firebase

    deploy-pr:
      name: "Deploy Web Example App (PR)"
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: ./example
      if: >
        github.event.workflow_run.event == 'pull_request' &&
        github.event.workflow_run.conclusion == 'success'
      steps:
        - name: Download Web Artifact
          uses: actions/github-script@v6.4.1
          with:
            script: |
              var artifacts = await github.actions.listWorkflowRunArtifacts({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 run_id: ${{github.event.workflow_run.id }},
              });
              var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                return artifact.name == "web-build"
              })[0];
              var download = await github.actions.downloadArtifact({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 artifact_id: matchArtifact.id,
                 archive_format: 'zip',
              });
              var fs = require('fs');
              fs.writeFileSync('${{github.workspace}}/web-build.zip', Buffer.from(download.data));
        - name: Unzip Web Artifact
          run: unzip web-build.zip
        - name: Publish Preview Web App
          uses: FirebaseExtended/action-hosting-deploy@main
          with:
            repoToken: "${{ secrets.GITHUB_TOKEN }}"
            firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FLEAFLET }}"
            expires: 30d
            projectId: fleaflet-firebase